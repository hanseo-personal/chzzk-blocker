// popup.js

document.addEventListener('DOMContentLoaded', function() {
    const blockStreamsToggle = document.getElementById('blockStreamsToggle');
        const blockPreviewToggle = document.getElementById('blockPreviewToggle');
            const blockBannerToggle = document.getElementById('blockBannerToggle');
                const tagInput = document.getElementById('tagInput');
                    const addTagBtn = document.getElementById('addTagBtn');
                        const blockedTagsList = document.getElementById('blockedTagsList');
                            const toggleTagListBtn = document.getElementById('toggleTagList');
                                const blockedTagsContainer = document.getElementById('blockedTagsContainer');

                                    let currentBlockedTags = [];

                                        function renderBlockedTags() {
                                                blockedTagsList.innerHTML = '';
                                                        if (currentBlockedTags.length === 0) {
                                                                    const li = document.createElement('li');
                                                                                li.textContent = '차단 태그가 없습니다.';
                                                                                            li.style.fontStyle = 'italic';
                                                                                                        li.style.color = '#777';
                                                                                                                    li.style.textAlign = 'center';
                                                                                                                                li.style.borderBottom = 'none';
                                                                                                                                            blockedTagsList.appendChild(li);
                                                                                                                                                    } else {
                                                                                                                                                                currentBlockedTags.forEach(tag => {
                                                                                                                                                                                const li = document.createElement('li');
                                                                                                                                                                                                li.textContent = tag;

                                                                                                                                                                                                                const deleteBtn = document.createElement('button');
                                                                                                                                                                                                                                deleteBtn.textContent = 'X';
                                                                                                                                                                                                                                                deleteBtn.onclick = function() {
                                                                                                                                                                                                                                                                    removeTag(tag);
                                                                                                                                                                                                                                                                                    };
                                                                                                                                                                                                                                                                                                    li.appendChild(deleteBtn);
                                                                                                                                                                                                                                                                                                                    blockedTagsList.appendChild(li);
                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                addTagBtn.addEventListener('click', function() {
                                                                                                                                                                                                                                                                                                                                                        const newTag = tagInput.value.trim();
                                                                                                                                                                                                                                                                                                                                                                if (newTag && !currentBlockedTags.includes(newTag)) {
                                                                                                                                                                                                                                                                                                                                                                            currentBlockedTags.push(newTag);
                                                                                                                                                                                                                                                                                                                                                                                        tagInput.value = '';
                                                                                                                                                                                                                                                                                                                                                                                                    chrome.storage.sync.set({ blockedTags: currentBlockedTags }, function() {
                                                                                                                                                                                                                                                                                                                                                                                                                    renderBlockedTags();

                                                                                                                                                                                                                                                                                                                                                                                                                                    setTimeout(() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                        const isCollapsed = blockedTagsContainer.style.maxHeight === '0px';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (isCollapsed && currentBlockedTags.length > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    toggleTagListBtn.click();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else if (!isCollapsed) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                blockedTagsContainer.style.maxHeight = (blockedTagsList.scrollHeight + 16) + 'px';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }, 100);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    console.log('chzzk-blocker: 태그 추가됨:', newTag);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                function removeTag(tagToRemove) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        currentBlockedTags = currentBlockedTags.filter(tag => tag !== tagToRemove);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                chrome.storage.sync.set({ blockedTags: currentBlockedTags }, function() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            renderBlockedTags();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    setTimeout(() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (currentBlockedTags.length === 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        blockedTagsContainer.style.maxHeight = '0px';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            blockedTagsContainer.style.padding = '0';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                blockedTagsContainer.style.border = '1px solid transparent';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    toggleTagListBtn.textContent = '펼치기';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const isCollapsed = blockedTagsContainer.style.maxHeight === '0px';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (isCollapsed) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    toggleTagListBtn.click();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                blockedTagsContainer.style.maxHeight = (blockedTagsList.scrollHeight + 16) + 'px';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }, 100);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            console.log('chzzk-blocker: 태그 삭제됨:', tagToRemove);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            chrome.storage.sync.get(['blockedTags', 'chzzkBlockerEnabled', 'chzzkPreviewBlockerEnabled', 'chzzkBannerBlockerEnabled'], function(result) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (result.blockedTags) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                currentBlockedTags = result.blockedTags;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                renderBlockedTags();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        blockedTagsContainer.style.maxHeight = '0px';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                blockedTagsContainer.style.padding = '0';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        blockedTagsContainer.style.border = '1px solid transparent';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                toggleTagListBtn.textContent = '펼치기';

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        blockStreamsToggle.checked = typeof result.chzzkBlockerEnabled === 'undefined' ? true : result.chzzkBlockerEnabled;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                blockPreviewToggle.checked = typeof result.chzzkPreviewBlockerEnabled === 'undefined' ? true : result.chzzkPreviewBlockerEnabled;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        blockBannerToggle.checked = typeof result.chzzkBannerBlockerEnabled === 'undefined' ? true : result.chzzkBannerBlockerEnabled;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                blockStreamsToggle.addEventListener('change', function() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        chrome.storage.sync.set({ chzzkBlockerEnabled: blockStreamsToggle.checked }, function() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    console.log('chzzk-blocker: 방송 차단 기능 활성화 상태 저장:', blockStreamsToggle.checked);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    blockPreviewToggle.addEventListener('change', function() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            chrome.storage.sync.set({ chzzkPreviewBlockerEnabled: blockPreviewToggle.checked }, function() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        console.log('chzzk-blocker: 대문 미리보기 숨기기 상태 저장:', blockPreviewToggle.checked);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        blockBannerToggle.addEventListener('change', function() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                chrome.storage.sync.set({ chzzkBannerBlockerEnabled: blockBannerToggle.checked }, function() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            console.log('chzzk-blocker: 상단 배너 숨기기 상태 저장:', blockBannerToggle.checked);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            toggleTagListBtn.addEventListener('click', function() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const isCollapsed = blockedTagsContainer.style.maxHeight === '0px';

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (isCollapsed) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                blockedTagsContainer.style.maxHeight = (blockedTagsList.scrollHeight + 16) + 'px';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            blockedTagsContainer.style.padding = '8px';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        blockedTagsContainer.style.border = '1px solid #ddd';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    toggleTagListBtn.textContent = '접기';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        blockedTagsContainer.style.maxHeight = '0px';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    blockedTagsContainer.style.padding = '0';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                blockedTagsContainer.style.border = '1px solid transparent';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            toggleTagListBtn.textContent = '펼치기';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tagInput.addEventListener('keydown', function(event) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (event.key === 'Enter') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                event.preventDefault();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            setTimeout(() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            addTagBtn.click();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }, 0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });
